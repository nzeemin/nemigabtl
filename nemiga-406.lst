; Дизассемблированное ПЗУ компьютера НЕМИГА ПК 588 версия 4.06
;
160000: DW	177570
160002: DW	160210, 000341		; Вектор прерывания сигнала/команды HALT
160006: DW	161726, 000340		; Вектор прерывания начального пуска
160012: DW	161142, 000340
160016: JMP    	@#163466		; MODE3
160022: JMP    	@#163504		; SYSLIN -- Вывод в служебную строку
160026: JMP    	@#163722		; TT.OUT
160032: JMP    	@#163726		; SYSOUT
160036: JMP    	@#162274		; PRINT
160042: JMP    	@#165346
160046: JMP    	@#165340
160052: JMP    	@#165342
160056: JMP    	@#165376
160062: JMP    	@#165370
160066: JMP    	@#165372
160072: JMP    	@#165606
160076: JMP    	@#165600
160102: JMP    	@#165602
160106: JMP    	@#165672
160116: JMP    	@#165664
160122: JMP    	@#162236		; DUMP
160126: JMP    	@177754			; SOUND

; ==== Обработчики прерываний ========================================================

; Обработка канального сигнала СБРОС
160142: MOV	#000357, @#000206
160150: CLR	@#177560
160154: MOV	#000200, @#177564
160162: CLR	@#177770
160166: BIC	#177541, @#177766
160174: MOV	(SP)+, R0
160176: JMP	@#161074		; Завершаем обработку прерывания HALT
;
; Обработка нажатия СТОП?? кнопки ОСТ??
160202: MOV	(SP)+, R0		; Восстанавливаем R0
160204: JMP	@#161142		; Переходим к сохранению регистров и пульту
;
; Обработчик прерывания по сигналу/команде HALT
160210: CMP	#056364, @#177776	; Проверка, настроена ли память режима HALT
160216: BEQ	160224			; Да, настроена
160224: MOV	R0, -(SP)		; Сохраняем R0 чтобы не испортить
160226: BIS	#000200, @#177564
160234: BIT	#176000, @#170006	; Проверка регистра фиксации HALT
160242: BMI	160142			; Канальный сигнал СБРОС? => переходим
160244: BEQ	160202			; 6 ст битов пусты - кнопка ОСТ?? => переходим
160246: BIT	#004000, @#170006	; Сигнал Н4? -- адаптер локальной сети
160254: BEQ	160262			; Нет
160262: BIT	#040000, @#170006	; Сигнал Н1? -- обращение к 177566
160270: BEQ	160302
160302: BIT	#020000, @#170006
160310: BEQ	160334
160312: MOVB	@#177767, R0
160316: BEQ	160326
160326: BIC	#177677, @#177560
160334: MOV	@#170006, R0
160340: BIT	#002000, R0
160344: BEQ	160606
160346: BIC	#177400, R0
160352: BEQ	160202
160354: TSTB	@#177560
160360: BMI	160606
160362: MOV	R1, -(SP)
160364: MOV	R2, -(SP)
160366: TSTB	@#177761
160372: BNE	160410
160374: CALL	@#160126		; SOUND
160400: BR	160410			;
160410: MOV	#177766, R1
160414: MOV	#000100, R2
160420: TSTB	(R1)
160422: BPL	160522
160522: MOV	(SP)+, R2
160524: MOV	(SP)+, R1
160526: MOV	R0, @#177562
160532: MOV	(SP)+, R0
160534: BIS	#000200, @#177560
160542: BIT	#000100, @#177560
160550: BEQ	161074			; ?? => Завершаем обработку прерывания HALT

160606: MOV	(SP)+, R0		; Восстанавливаем R0
160610: BIT	#010000, @#170006	; Сигнал Н3?
160616: BEQ	161074			; Нет => Завершаем обработку прерывания HALT
160620: MOV	R4, -(SP)
160622: TST	@#177760
160626: BPL	160750
160630: MOV	@#177752, R4
160634: INCB	@#177760
160640: CMPB	@#177760, 177777(R4)
160646: BLO	160750
160650: TSTB	(R4)
160652: BMI	160744
160654: BITB	#000037, (R4)
160660: BNE	160740
160662: BIC	#100000, @#177760
160670: BITB	#000040, (R4)
160674: BNE	160712
160676: TSTB	(R4)
160700: BEQ	160750

160750: DECB	@#177756
160754: BPL	161034
160756: MOVB	#000007, @#177756
160764: COMB	@#177757
160770: MOV	@#177772, R4
160774: BMI	161034
160776: TSTB	@#177771
161002: BMI	161034
161004: ADD	@#177746, R4
161010: BMI	161034
161012: ROL	R4
161014: BMI	161034
161016: BIS	#000001, @#177574
161024: COM	(R4)		; Инвертирование восьми пикселей -- курсор
161026: BIC	#000001, @#177574
161034: MOV	(SP)+, R4
161036: TSTB	000002(SP)
161042: BMI	161074			; ?? => Завершаем обработку прерывания HALT

; Завершение обработки прерывания HALT
161074: CLRB	@#170006		; Разрешение прерываний
161100: RTI
	
; Обработка прерывания?? Сохранение регистров и переход к пульту
161142: MOV	(SP)+, @#177736		; Сохраняем PSW
161146: MOV	(SP)+, @#177740		; Сохраняем PC
161152: MOV	SP, @#177734		; Сохраняем SP
161156: MOV	#177734, SP		; Сохраняем остальные регистры
161162: MOV	R5, -(SP)		; -> 177732
161164: MOV	R4, -(SP)		; -> 177730
161166: MOV	R3, -(SP)		; -> 177726
161170: MOV	R2, -(SP)		; -> 177724
161172: MOV	R1, -(SP)		; -> 177722
161174: MOV	R0, -(SP)		; -> 177720 -- начало блока регистров
161176: MOV	@#000004, -(SP)
161202: MOV	@#000006, -(SP)
161206: MOV	@#177766, -(SP)
161212: CLR	@#177766
161216: MOV	#000340, @#000006	; PSW для прерывания
161224: MOV	#161444, @#000004	; Адрес прерывания??
161232: MOV	#000060, @#170010
161240: BR	161444			; Переход к пультовому терминалу
;
; Вывод приглашения пульта и ожидание команды
161444: MOV	#162704, R5		; Строка "Пульт>"
161450: MOV	#177712, SP
161454: MOV	#000340, @#000006	; PSW для прерывания
161462: MOV	#161546, @#000004	; Адрес прерывания??
161470: CALL	@#162274
161474: CALL	@#162310
161500: MOV	R5, R2
161502: CMPB	#000057, R0
161506: BEQ	161246
161510: CMPB	#000123, R0
161514: BEQ	161554
161516: CMPB	#000107, R0
161522: BEQ	161356
161524: CMPB	#000104, R0
161530: BEQ	161676
161546: MOV	#162703, R5
161552: BR	161450
161676: CMP	R5, #000007
161702: BHI	161546
161704: CALL	@#162726

;
; ==== Программа холодного старта ====================================================
;
; Холодный старт при включении питания
161726: MOV	#001000, SP
161732: CLR	R0
161734: MOV	#056364, -(R0)
161740: MOV	#164042, -(R0)
161744: CLR	@#177574
161750: MOV	#000007, R1
161754: CLR	-(R0)
161756: SOB	R1, 161754
161760: MOV	#162516, -(R0)
161764: MOV	#162002, @#000004
161772: CLR	@#170024
161776: MOV	#162426, (R0)
162002: MOV	#165036, -(R0)
162006: MOV	(R0), -(R0)
162010: MOV	#003100, -(R0)
162014: RESET	
162016: MOV	#000021, R0
162022: CALL	@#163722
162026: MOV	#161142, @#000004
162034: MOV	#000340, @#000006
162042: MOV	#170010, R4
162046: CALL	@#163504
162052: BR	162056
162056: MOV	#000014, (R4)
162062: MOV	#162671, R5
162066: CALL	@#162274
162072: MOV	#162226, @#000004
162100: BIT	#100040, (R4)
162104: BMI	162226
162226: MOV	#002060, (R4)
162232: JMP	@#161546


;
; ==== Программы вывода на экран чисел и строк =======================================
;
; Подпрограмма DUMP Вывод слова как 8-ричного числа; R3 = число
162236: MOV	#000006, R1
162242: CLR	R0
162244: ROL	R3
162246: ROL	R0
162250: ADD	#000060, R0
162254: CALL	@#163722
162260: CLR	R0
162262: ROL	R3
162264: ROL	R0
162266: ROL	R3
162270: ROL	R0
162272: SOB	R1, 162244
162274: MOVB	(R5)+, R0
162276: BNE	162302
162300: RETURN	
162302: CALL	@#163722
162306: BR	162274
162310: CLR	R1
162312: CLR	R5
162314: TSTB	@#177560
162320: BPL	162314
162322: MOVB	@#177562, R3
162326: CMPB	R3, #000177
162332: BNE	162362
162362: MOV	R3, R0
162364: CMPB	R0, #000040
162370: BLO	162300
162372: CALL	@#163722
162376: BIC	#177407, R3
162402: CMP	#000060, R3
162406: BNE	162300
162426: MOV	R4, -(SP)
162430: BICB	#000200, @#177761
162436: CLR	@#170024
162442: MOV	000002(SP), R4
162446: MOV	000002(R4), R4
162452: BNE	162460
162460: TSTB	(R4)
162462: BEQ	162514
162464: MOV	R4, @#177750
162470: MOV	#001516, @#170020
162476: MOVB	(R4)+, @#170030
162502: CALL	@#162520
162506: BISB	#000200, @#177761
162514: MOV	(SP)+, R4
162516: RETURN	
162520: MOV	R3, -(SP)
162522: MOVB	(R4)+, R3
162524: BIC	#177760, R3
162530: ASL	R3
162532: MOV	162564(R3), @#170022
162540: MOVB	(R4)+, @#170024
162544: CLRB	@#177760
162550: MOV	R4, @#177752
162554: TST	@#170026
162560: MOV	(SP)+, R3
162562: RETURN	
162726: CALL	@#163466
162732: MOV	#000001, R4
162736: MOV	R5, -(SP)
162740: ASR	R5
162742: BHIS	162750
162750: MOV	R5, @#004002
162754: MOV	#000400, -(SP)
162760: CLR	-(SP)
162762: MOV	R4, -(SP)
162764: MOV	#000006, R1
162770: MOV	#000070, R0
162774: CALL	@#163256
163000: SOB	R1, 162770
163002: MOV	#000030, R0
163006: CALL	@#163256
163012: CLR	@#177106
163016: BIT	R4, @#177106
163022: BNE	163016
163024: BIT	#000010, (R5)
163030: BNE	163002
163032: CLR	@#177106
163036: BIT	R4, (R5)
163040: BEQ	163046
163046: MOVB	R4, R0
163050: MOV	#004004, R3
163054: CALL	@#163316
163256: MOV	#177106, R5
163262: MOV	#000006, R2
163266: CLR	(R5)
163270: BIT	#000001, (R5)
163274: BNE	163270
163276: SOB	R2, 163266
163300: BIS	@#004002, R0
163304: MOV	R0, -(R5)
163306: TST	-(R5)
163310: MOV	#000001, -(R5)
163314: RETURN	
163316: MOV	R3, R1
163320: MOV	R0, -(SP)
163322: MOV	#000012, R4
163326: ADD	#000202, R4
163332: SOB	R0, 163326
163334: MOV	#000010, R0
163340: CALL	@#163256
163344: MOV	#177102, R2
163350: TSTB	(R5)
163352: BPL	163350
163354: MOVB	(R2), (R1)+
163356: SOB	R4, 163350
163360: MOV	(R5), R0
163362: CLR	(R5)
163364: BIT	#000141, R0
163370: BEQ	163374
163374: ADD	#000012, R3
163400: MOV	#000100, R0
163404: CLR	R2
163406: MOVB	@#004007, R4
163412: MOV	@#004012, R5
163416: COM	R5
163420: CLC	
163422: XOR	R4, (R3)
163424: XOR	R5, (R3)
163426: ROL	R4
163430: ROR	R5
163432: ROL	R0
163434: MOVB	(R3)+, R1
163436: ADD	R1, R2
163440: MOVB	(R3)+, R1
163442: ADD	R1, R2
163444: ASR	R0
163446: SOB	R0, 163422
163450: CMP	R2, (R3)+
163452: BEQ	163456
163454: HALT	

; MODE3 -- Вызов подпрограммы с запретом прерываний
163466: MOVB	#000003, @#170006
163474: CALL	@(SP)+
163476: CLRB	@#170006
163502: RETURN	
;
; SYSLIN
163504: CALL	@#163466
163510: MOV	R0, -(SP)
163512: MOV	R1, -(SP)
163514: MOV	#177772, R0
163520: MOV	(R0), -(SP)
163522: MOV	-(R0), -(SP)
163524: MOV	000012(SP), R1
163530: CMP	(R0)+, (R1)+
163532: MOV	(R1), R1
163534: MOVB	(R1)+, (R0)+
163536: CLRB	(R0)+
163540: ADD	#176000, -(R0)
163544: CLR	-(R0)
163546: BIS	#000010, -(R0)
163552: CMP	@#177772, #176060
163560: BGE	163574
163562: MOVB	(R1)+, R0
163564: BEQ	163700
163566: CALL	@#163726
163572: BR	163552
163574: MOV	R1, -(SP)
163576: MOV	#162702, R5
163602: MOV	@#167776, R3
163606: CALL	@#162236
163612: MOV	(SP)+, R1
163614: MOV	(R4), R3
163616: INC	@#177772
163622: MOV	#000004, R2
163626: BIC	#102777, R3
163632: BEQ	163700
163634: ROL	R3
163636: COM	R3
163640: BIC	#007777, R3
163644: BEQ	163650
163650: MOVB	(R1)+, R0
163652: CALL	@#163726
163656: SOB	R2, 163650
163660: TST	R3
163662: BEQ	163700
163700: MOV	#177766, R0
163704: BIC	#000010, (R0)+
163710: MOV	(SP)+, (R0)+
163712: MOV	(SP)+, (R0)+
163714: MOV	(SP)+, R1
163716: MOV	(SP)+, R0
163720: RETURN	

; ==== Программа вывода символов на экран ============================================
;
; TT.OUT Вывод символа на экран; мл.байт R0 = символ
163722: CALL	@#163466
; SYSOUT Вход -- вывод символа
163726: MOV	SP, @#177642
163732: MOV	#177642, SP
163736: BIS	#000001, @#177574
163744: CALL	@177774
163750: BIC	#000001, @#177574
163756: MOV	(SP), SP
163760: RETURN	

164042: MOV	R0, -(SP)
164044: MOV	R1, -(SP)
164046: MOV	R2, -(SP)
164050: MOV	R3, -(SP)
164052: MOV	R4, -(SP)
164054: MOV	R5, -(SP)
164056: CALL	@#165206
164062: MOV	000012(SP), R5
164066: BIC	#177400, R5
164072: MOV	#000100, R1
164076: MOV	#177770, R2
164102: TSTB	(R2)
164104: BPL	164136
164136: BNE	163762
164140: MOVB	@#177766, R4
164144: BPL	164176
164176: CMP	R5, #000040
164202: BLO	164302
164204: ROLB	R5
164206: BPL	164212
164210: BIC	R1, R5
164212: BHIS	164216
164214: BIS	R1, R5
164216: ASR	R5
164220: ADD	#002000, R3
164224: ASL	R3
164226: SUB	#000040, R5
164232: MUL	R5, #000012
164236: ADD	#166064, R5
164242: MOV	#000012, R4
164246: ASL	R1
164250: MOVB	(R5), R2
164252: SWAB	R2
164254: CLRB	R2
164256: BISB	(R5)+, R2
164260: BIC	@#177764, R2
164264: MOV	@#177762, R0
164270: XOR	R0, R2
164272: MOV	R2, (R3)
164274: ADD	R1, R3
164276: SOB	R4, 164250
164300: BR	164470
164302: MOV	#165324, R2
164306: BITB	#000010, R4
164312: BNE	164324
164314: CMP	(R2)+, (R2)+
164316: TSTB	R4
164320: BMI	164324
164322: CMP	(R2)+, (R2)+
164324: MOV	(R2)+, R0
164326: MOV	(R2), R1
164330: ASHC	R0, R5
164332: BPL	164600
164334: MOVB	165250(R5), R4
164340: BIC	#177400, R4
164344: ASL	R4
164346: MOV	#177770, R2
164352: ADD	R4, PC
164436: CLR	(R2)
164440: TST	-(R2)
164442: CLR	-(R2)
164444: CLR	-(R2)
164446: BR	164600
164450: COMB	177760(R5)
164454: BR	164600
164470: MOV	#177772, R2
164474: INC	(R2)
164476: MOV	(R2), R3
164500: MOV	R3, R4
164502: BIC	#177700, R4
164506: BNE	164600
164516: ADD	#001200, R3
164522: CMP	R3, #034700
164526: BLO	164606
164600: BR	165116
164602: BIC	#000077, R3
164606: MOV	R3, @#177772
164612: BR	165116
164614: MOV	R3, R4
164616: BIC	#177700, R4
164622: CMP	R4, #000077
164626: BHIS	165116
164630: ADD	#000010, R3
164634: BIC	#000007, R3
164640: BR	164606
165072: CLR	R5
165074: BR	165102
165076: MOV	#002000, R5
165102: CLR	@#177772
165106: ASL	R5
165110: CLR	(R5)+
165112: TST	R5
165114: BPL	165110
165116: CALL	@#165206
165122: MOV	(SP)+, R5
165124: MOV	(SP)+, R4
165126: MOV	(SP)+, R3
165130: MOV	(SP)+, R2
165132: MOV	(SP)+, R1
165134: MOV	(SP)+, R0
165136: RETURN	
165206: MOV	@#177772, R3
165212: BMI	165246
165214: TSTB	@#177771
165220: BMI	165246
165222: TST	@#177756
165226: BPL	165246
165246: RETURN	
